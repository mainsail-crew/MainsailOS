set -x
set -e

export LC_ALL=C

# load common functions
source /common.sh
install_cleanup_trap

BASE_USER=pi
BASE_PASSWORD=armbian

if_group_exists_run() {
    group=$1
    if grep -q "${group}" /etc/group; then
        "${@:2}"
    fi
}

echo_green "Adding base user ${BASE_USER}"
password=$(perl -e 'printf("%s\n", crypt($ARGV[0], "password"))' "${BASE_PASSWORD}")
useradd -m -p "${password}" -s /bin/bash "${BASE_USER}"
usermod -a -G sudo "${BASE_USER}"

echo "${BASE_USER} ALL=(ALL:ALL) NOPASSWD:ALL" >> /etc/sudoers

### Create group for gpio usage
sudo groupadd gpio
### END Substep 1

if_group_exists_run i2c usermod -aG i2c "${BASE_USER}"
usermod -aG video,audio,plugdev,games,netdev,sudo,systemd-journal,gpio "${BASE_USER}"

## patch sshd_config
sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^X11Forwarding/#X11Forwarding/' /etc/ssh/sshd_config
sed -i 's/^#MaxAuthTries 6/MaxAuthTries 3/' /etc/ssh/sshd_config
## END Step

## Step 4: Try patching first login in build stage
if [[ -f "/root/.not_logged_in_yet" ]]; then
    rm -f /root/.not_logged_in_yet
fi
## END Step
