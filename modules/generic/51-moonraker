#!/bin/bash

set -x
set -e

export LC_ALL=C

# load common functions
source /common.sh
install_cleanup_trap

source /files/00-config

DIR="moonraker"
SRC_DIR="/home/${BASE_USER}/${DIR}"

REPO="https://github.com/Arksine/moonraker.git"
DEPS="git"

apt-get install --yes "${DEPS}"

echo "Cloning Repository"
pushd "/home/${BASE_USER}" &> /dev/null || exit 1
sudo -u "${BASE_USER}" git clone ${REPO} ${DIR}

create_user_directories

echo_green "Execute installer"
pushd "$SRC_DIR" &> /dev/null || exit 1
sudo -u "${BASE_USER}" ./scripts/install-moonraker.sh -s -z

popd &> /dev/null || exit 1

cp /files/moonraker.conf /home/"${BASE_USER}"/printer_data/config/moonraker.conf
systemctl_if_exists enable moonraker.service
